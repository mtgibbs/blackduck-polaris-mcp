{
  "project": "blackduck-polaris-mcp",
  "branchName": "ralph/tests-api",
  "description": "Complete the Tests API for the Black Duck Polaris MCP server. Existing code covers test listing (getTests), single test detail (getTest), and test metrics by test ID (getTestMetrics). This branch adds missing types, refactors the existing service to use options objects, and implements 9 new endpoints across create/update tests, comments, artifacts, profiles, subscription-level metrics, and last-run queries. All endpoints use base path /api/tests with vendor media types under application/vnd.polaris.tests.*-1+json.",
  "userStories": [
    {
      "id": "PRD-T1",
      "title": "Add missing types and refactor existing service to options objects",
      "description": "Add all new TypeScript interfaces needed for subsequent stories to src/types/polaris.ts. Refactor the existing getTests service function from positional parameters (projectId, branchId, status) to a single options object pattern (GetTestsOptions), matching the convention used in the bug-tracking and findings services. Update the existing get-tests.ts tool handler to use the new options-based signature.",
      "acceptanceCriteria": [
        "In src/types/polaris.ts: Add CreateTestRequest interface with fields projectId (string), branchId (optional string), assessmentTypes (string[]), testMode (optional string), scanMode (optional string), artifacts (optional string[]), notes (optional string), triage (optional string), profileDetails (optional { id?: string, content?: string })",
        "In src/types/polaris.ts: Add TestAction type alias = 'RESUME' | 'CANCEL' | 'FAILED'",
        "In src/types/polaris.ts: Add UpdateTestRequest interface with fields action (TestAction), artifacts (optional string[]), toolId (optional string), notes (optional string)",
        "In src/types/polaris.ts: Add TestComment interface with fields id (string), testId (string), text (string), createdAt (string), author (optional string), _links (optional LinkEntry[])",
        "In src/types/polaris.ts: Add TestArtifactMetadata interface with fields id (string), type (string), filename (optional string), status (optional string), signedUrl (optional string), _links (optional LinkEntry[])",
        "In src/types/polaris.ts: Add TestProfile interface with fields id (string), name (string), url (optional string), configuration (optional Record<string, unknown>), _links (optional LinkEntry[])",
        "In src/types/polaris.ts: Add SubscriptionMetrics interface with fields subscriptionId (string), metrics (Record<string, unknown>), _links (optional LinkEntry[])",
        "In src/services/tests.ts: Add GetTestsOptions interface with fields projectId (optional string), branchId (optional string), status (optional string), filter (optional string)",
        "In src/services/tests.ts: Refactor getTests(projectId?, branchId?, status?) to getTests(options?: GetTestsOptions) that passes options fields to testsApi.getTests()",
        "In src/mcp/tools/get-tests.ts: Update handler from getTests(project_id, branch_id, status) to getTests({ projectId: project_id, branchId: branch_id, status })",
        "Add optional filter field to the get-tests.ts tool schema: filter: z.string().optional().describe('RSQL filter expression')",
        "Wire the filter field through to the service/API layer",
        "Reference specs/tests.yaml for the canonical test, comment, artifact, profile, and metrics schemas",
        "`deno task check` passes with no type errors",
        "`deno task lint` passes",
        "`deno fmt --check` passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Foundation story. Must complete before PRD-T2 through PRD-T4. The refactor of getTests to options objects is a breaking internal change to the service layer but the MCP tool interface (snake_case params) stays the same for external consumers. The API layer (src/api/tests.ts) already uses an options object (TestQueryParams) so only the service layer needs refactoring.",
      "claimed_by": "agent-1",
      "claimed_at": "2026-02-20T03:12:55Z"
    },
    {
      "id": "PRD-T2",
      "title": "Implement create test and update test endpoints",
      "description": "Add two endpoints: (1) POST /api/tests to create new security scan tests with Content-Type application/vnd.polaris.tests.tests-bulk-create-1+json. The response is multi-status (207) containing individual test creation results. (2) PATCH /api/tests/{testId} to update a test (RESUME, CANCEL, or FAILED actions) with Content-Type application/vnd.polaris.tests.test-actions-1+json.",
      "acceptanceCriteria": [
        "In src/api/tests.ts: Add CONTENT_TYPE_CREATE = 'application/vnd.polaris.tests.tests-bulk-create-1+json' and CONTENT_TYPE_UPDATE = 'application/vnd.polaris.tests.test-actions-1+json' and ACCEPT_TEST = 'application/vnd.polaris.tests.test-1+json' constants",
        "In src/api/tests.ts: Add createTest(body: CreateTestRequest) — POST /api/tests using client.fetch() with contentType CONTENT_TYPE_CREATE, accept 'application/vnd.polaris.tests.tests-bulk-1+json', returns the creation response",
        "In src/api/tests.ts: Add updateTest(testId: string, body: UpdateTestRequest) — PATCH /api/tests/{testId} using client.fetch() with contentType CONTENT_TYPE_UPDATE, accept ACCEPT_TEST, returns Test",
        "In src/services/tests.ts: Add createTest(options: CreateTestOptions) service wrapper with fields matching CreateTestRequest: projectId, branchId?, assessmentTypes, testMode?, scanMode?, artifacts?, notes?, triage?, profileDetails?",
        "In src/services/tests.ts: Add updateTest(options: UpdateTestOptions) service wrapper with fields: testId (string), action (TestAction), artifacts? (string[]), toolId? (string), notes? (string)",
        "Create src/mcp/tools/create-test.ts: Tool create_test with schema project_id (required), branch_id (optional), assessment_types (required string array description), test_mode (optional), scan_mode (optional), artifacts (optional array), notes (optional), triage (optional). Annotations: { readOnlyHint: false, openWorldHint: true }",
        "Create src/mcp/tools/update-test.ts: Tool update_test with schema test_id (required), action (required string enum RESUME|CANCEL|FAILED), artifacts (optional array), tool_id (optional), notes (optional). Annotations: { readOnlyHint: false, openWorldHint: true }",
        "Register both tools in src/mcp/tools/index.ts",
        "Reference specs/tests.yaml: createTests-v1 (line 213 under POST /api/tests), updateTest-v1 (line 958 under PATCH /api/tests/{testId})",
        "`deno task check` passes",
        "`deno task lint` passes",
        "`deno fmt --check` passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Depends on PRD-T1 for CreateTestRequest, UpdateTestRequest, and TestAction types. POST /api/tests returns 207 Multi-Status (not 200) with per-test results. The create endpoint uses a unique Content-Type (tests-bulk-create-1+json). The update endpoint supports RESUME (to continue paused tests), CANCEL, and FAILED actions.",
      "claimed_by": "agent-3",
      "claimed_at": "2026-02-20T03:13:58Z"
    },
    {
      "id": "PRD-T3",
      "title": "Implement comments, artifacts, and profiles endpoints",
      "description": "Add five endpoints: (1) GET /api/tests/{testId}/comments to fetch comments for a test (max 500 entries, sorted by created date descending). (2) POST /api/tests/artifacts to create a test artifact metadata entry and get a signed upload URL. (3) GET /api/tests/{testId}/artifacts to list artifact metadata for a test. (4) GET /api/tests/{testId}/artifacts/{artifactId} to download a specific artifact (binary). (5) GET /api/tests/{testId}/profiles to fetch DAST profile details for a test.",
      "acceptanceCriteria": [
        "In src/api/tests.ts: Add ACCEPT_COMMENTS = 'application/vnd.polaris.tests.tests-comments-1+json', ACCEPT_ARTIFACTS = 'application/vnd.polaris.tests.test-artifacts-1+json', ACCEPT_ARTIFACTS_LIST = 'application/vnd.polaris.tests.test-artifacts-list-1+json', ACCEPT_PROFILES = 'application/vnd.polaris.tests.test-profiles-1+json' constants",
        "In src/api/tests.ts: Add getTestComments(testId) — GET /api/tests/{testId}/comments using client.getAllOffset<TestComment>(), accepts ACCEPT_COMMENTS",
        "In src/api/tests.ts: Add createTestArtifact(body) — POST /api/tests/artifacts using client.fetch() with contentType and accept ACCEPT_ARTIFACTS, returns TestArtifactMetadata",
        "In src/api/tests.ts: Add getTestArtifacts(testId) — GET /api/tests/{testId}/artifacts using client.getAllOffset<TestArtifactMetadata>(), accepts ACCEPT_ARTIFACTS_LIST",
        "In src/api/tests.ts: Add getTestArtifact(testId, artifactId) — GET /api/tests/{testId}/artifacts/{artifactId} using client.get() for binary download",
        "In src/api/tests.ts: Add getTestProfiles(testId) — GET /api/tests/{testId}/profiles using client.get<TestProfile>(), accepts ACCEPT_PROFILES",
        "In src/services/tests.ts: Add getTestComments(options: { testId: string }) service wrapper",
        "In src/services/tests.ts: Add createTestArtifact(options) service wrapper with artifact creation fields",
        "In src/services/tests.ts: Add getTestArtifacts(options: { testId: string }) service wrapper",
        "In src/services/tests.ts: Add getTestArtifact(options: { testId: string, artifactId: string }) service wrapper",
        "In src/services/tests.ts: Add getTestProfiles(options: { testId: string }) service wrapper",
        "Create src/mcp/tools/get-test-comments.ts: Tool get_test_comments with schema test_id (required). Annotations: { readOnlyHint: true, openWorldHint: true }",
        "Create src/mcp/tools/create-test-artifact.ts: Tool create_test_artifact with schema for artifact creation fields (type, filename, file_hash, file_size, etc.). Annotations: { readOnlyHint: false, openWorldHint: true }",
        "Create src/mcp/tools/get-test-artifacts.ts: Tool get_test_artifacts with schema test_id (required). Annotations: { readOnlyHint: true, openWorldHint: true }",
        "Create src/mcp/tools/get-test-artifact.ts: Tool get_test_artifact with schema test_id (required), artifact_id (required). Annotations: { readOnlyHint: true, openWorldHint: true }",
        "Create src/mcp/tools/get-test-profiles.ts: Tool get_test_profiles with schema test_id (required). Annotations: { readOnlyHint: true, openWorldHint: true }",
        "Register all five tools in src/mcp/tools/index.ts",
        "Reference specs/tests.yaml: getCommentsByTestId-v1 (line 1413), createArtifact-v1 (line 1861), getAllArtifactsByTestId-v1 (line 2118), getArtifactByTestId-v1 (line 2351), getProfileByTestId-v1 (line 2810)",
        "`deno task check` passes",
        "`deno task lint` passes",
        "`deno fmt --check` passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Depends on PRD-T1 for TestComment, TestArtifactMetadata, and TestProfile types. The createTestArtifact endpoint does NOT upload file contents -- it returns a signedUrl for a subsequent PUT upload. The getTestArtifact endpoint returns binary (application/octet-stream) -- only SCREENSHOT artifact type is supported for download. Profiles endpoint is DAST-specific.",
      "claimed_by": "agent-1",
      "claimed_at": "2026-02-20T03:24:06Z"
    },
    {
      "id": "PRD-T4",
      "title": "Implement subscription metrics and last-run endpoints",
      "description": "Add two read-only endpoints: (1) GET /api/tests/metrics to fetch test metrics grouped per subscription with RSQL filter (currently only subscriptionId filter key supported). Uses Accept: application/vnd.polaris.tests.metrics-1+json. (2) GET /api/tests/last-run to retrieve the most recent completed test(s) for a specified assessment type and project, returning one entry per tool type. Requires assessmentType and projectId query params; branchId required for SAST/SCA/EA, profileId required for DAST.",
      "acceptanceCriteria": [
        "In src/api/tests.ts: Add ACCEPT_METRICS = 'application/vnd.polaris.tests.metrics-1+json' constant",
        "In src/api/tests.ts: Add getSubscriptionMetrics(params) — GET /api/tests/metrics using client.getAllOffset<SubscriptionMetrics>() with optional _filter param, accepts ACCEPT_METRICS",
        "In src/api/tests.ts: Add getLastRunTests(params) — GET /api/tests/last-run using client.getAllOffset<Test>() with required assessmentType and projectId query params plus optional branchId and profileId, accepts ACCEPT_TESTS (the existing tests list media type)",
        "In src/services/tests.ts: Add getSubscriptionMetrics(options?: { filter?: string }) service wrapper",
        "In src/services/tests.ts: Add getLastRunTests(options: GetLastRunTestsOptions) service wrapper with fields: assessmentType (required string), projectId (required string), branchId (optional string), profileId (optional string)",
        "Create src/mcp/tools/get-subscription-metrics.ts: Tool get_subscription_metrics with schema filter (optional string, described as 'RSQL filter, e.g. subscriptionId==\"{id}\"'). Annotations: { readOnlyHint: true, openWorldHint: true }",
        "Create src/mcp/tools/get-last-run-tests.ts: Tool get_last_run_tests with schema assessment_type (required string enum SAST|SCA|DAST|EXTERNAL_ANALYSIS), project_id (required string), branch_id (optional string, described as 'Required for SAST, SCA, and EXTERNAL_ANALYSIS assessment types'), profile_id (optional string, described as 'Required for DAST assessment type'). Annotations: { readOnlyHint: true, openWorldHint: true }",
        "Register both tools in src/mcp/tools/index.ts",
        "Reference specs/tests.yaml: getTestMetrics-v1 (line 2584 under GET /api/tests/metrics), getLastRunTests-v1 (line 3017 under GET /api/tests/last-run)",
        "`deno task check` passes",
        "`deno task lint` passes",
        "`deno fmt --check` passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Depends on PRD-T1 for SubscriptionMetrics type. Note: GET /api/tests/metrics is a different endpoint from GET /api/tests/{testId}/test-metrics (which already exists). The /metrics endpoint returns subscription-level aggregated metrics, while /test-metrics returns per-test issue severity counts. The last-run endpoint returns the most recently completed test per tool type for the given assessment type and project. branchId is mandatory for SAST, SCA, and EXTERNAL_ANALYSIS; profileId is mandatory for DAST.",
      "claimed_by": "agent-4",
      "claimed_at": "2026-02-20T03:24:31Z"
    }
  ]
}
