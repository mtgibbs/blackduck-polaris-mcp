## Codebase Patterns

- Tool files export a `ToolDefinition<typeof schema>` with schema as a plain object of Zod types (NOT wrapped in z.object())
- All read-only tools use `annotations: { readOnlyHint: true, openWorldHint: true }`
- Service layer functions match API layer function names but use "Options" suffix instead of "Params"
- API layer cursor-paginated endpoints use `client.getAllCursor()`, single-object endpoints use `client.get()`
- `ACCEPT_ISSUES` constant covers all issue-related endpoints including triage-history and detection-history
- `deno check agent.ts` requires npm package downloads and may not complete in network-restricted environments; `deno lint` and `deno fmt --check` work fine without network
- Services are auto-exported via `export *` from `src/services/index.ts` - no need to update that file

---

## 2026-02-19 - PRD-F2

- Implemented issue triage-history and detection-history endpoints
- Files changed:
  - `src/types/polaris.ts`: Added TriageHistoryTransaction, DetectionEventType, DetectionHistoryEvent, DetectionHistory types
  - `src/api/findings.ts`: Added getIssueTriageHistory() (cursor-paginated) and getIssueDetectionHistory() (single object)
  - `src/services/findings.ts`: Added getIssueTriageHistory() and getIssueDetectionHistory() service functions
  - `src/mcp/tools/get-issue-triage-history.ts`: New tool get_issue_triage_history
  - `src/mcp/tools/get-issue-detection-history.ts`: New tool get_issue_detection_history
  - `src/mcp/tools/index.ts`: Registered both new tools
  - `prd.json`: Set PRD-F2 passes: true
- `deno lint` passes, `deno fmt --check` passes
- `deno check` could not complete due to npm package download failures in this network-restricted environment (same issue would affect all agents)
- **Learnings for future iterations:**
  - Both triage-history and detection-history use `ACCEPT_ISSUES` media type (application/vnd.polaris.findings.issues-1+json)
  - Triage history is cursor-paginated (getAllCursor), detection history returns a single object (client.get)
  - The TriageHistoryTransaction type reuses existing TriageProperty and TriageAuthor types
  - New tool files follow exact same pattern as get-issue.ts: schema object + ToolDefinition export
  - npm package downloads may stall indefinitely in this sandbox (network restriction); deno lint/fmt work fine
---

## 2026-02-19 - PRD-BT2
- Implemented config CRUD and test connection endpoints across all layers:
  1. src/types/polaris.ts: Added CreateBugTrackingConfigRequest, UpdateBugTrackingConfigRequest, TestConnectionResult, CreateProjectMappingRequest, UpdateProjectMappingRequest, ExportCommentRequest interfaces (PRD-BT1 had not added these yet; added here since PRD-BT2 depends on them)
  2. src/api/bug-tracking.ts: Added createConfiguration() (POST with system query param), updateConfiguration() (PATCH), deleteConfiguration() (DELETE, returns void), testConnection() (POST /connection, returns TestConnectionResult)
  3. src/services/bug-tracking.ts: Added createBugTrackingConfiguration(), updateBugTrackingConfiguration(), deleteBugTrackingConfiguration(), testBugTrackingConnection() service wrappers with Options interfaces
  4. src/mcp/tools/create-bug-tracking-config.ts: New tool create_bug_tracking_config (readOnlyHint: false)
  5. src/mcp/tools/update-bug-tracking-config.ts: New tool update_bug_tracking_config (readOnlyHint: false)
  6. src/mcp/tools/delete-bug-tracking-config.ts: New tool delete_bug_tracking_config (readOnlyHint: false, destructiveHint: true)
  7. src/mcp/tools/test-bug-tracking-connection.ts: New tool test_bug_tracking_connection (readOnlyHint: true)
  8. src/mcp/tools/index.ts: Registered all four new tools
  9. prd.json: Set PRD-BT2 passes: true
- `deno task lint` passes, `deno fmt --check` passes
- **Learnings for future iterations:**
  - PRD-BT1 (foundation types) was not yet completed when starting PRD-BT2; the types needed (CreateBugTrackingConfigRequest etc.) were added here directly to polaris.ts
  - createConfiguration uses client.fetch() with method POST and a `params: { system }` field for the query param
  - deleteConfiguration returns void (204 response); tool handler returns jsonResponse({success: true, id})
  - testConnection uses POST but is considered read-only from user's perspective (readOnlyHint: true)
  - deno fmt catches ternary operator formatting on tool handler code â€” run `deno fmt` before checking
  - All six types required by PRD-BT1 were added (CreateBugTrackingConfigRequest, UpdateBugTrackingConfigRequest, TestConnectionResult, CreateProjectMappingRequest, UpdateProjectMappingRequest, ExportCommentRequest)
---
