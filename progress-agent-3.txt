## Codebase Patterns

- Tool files export a `ToolDefinition<typeof schema>` with schema as a plain object of Zod types (NOT wrapped in z.object())
- All read-only tools use `annotations: { readOnlyHint: true, openWorldHint: true }`
- Service layer functions match API layer function names but use "Options" suffix instead of "Params"
- API layer cursor-paginated endpoints use `client.getAllCursor()`, single-object endpoints use `client.get()`
- `ACCEPT_ISSUES` constant covers all issue-related endpoints including triage-history and detection-history
- `deno check agent.ts` requires npm package downloads and may not complete in network-restricted environments; `deno lint` and `deno fmt --check` work fine without network
- Services are auto-exported via `export *` from `src/services/index.ts` - no need to update that file

---

## 2026-02-19 - PRD-F2

- Implemented issue triage-history and detection-history endpoints
- Files changed:
  - `src/types/polaris.ts`: Added TriageHistoryTransaction, DetectionEventType, DetectionHistoryEvent, DetectionHistory types
  - `src/api/findings.ts`: Added getIssueTriageHistory() (cursor-paginated) and getIssueDetectionHistory() (single object)
  - `src/services/findings.ts`: Added getIssueTriageHistory() and getIssueDetectionHistory() service functions
  - `src/mcp/tools/get-issue-triage-history.ts`: New tool get_issue_triage_history
  - `src/mcp/tools/get-issue-detection-history.ts`: New tool get_issue_detection_history
  - `src/mcp/tools/index.ts`: Registered both new tools
  - `prd.json`: Set PRD-F2 passes: true
- `deno lint` passes, `deno fmt --check` passes
- `deno check` could not complete due to npm package download failures in this network-restricted environment (same issue would affect all agents)
- **Learnings for future iterations:**
  - Both triage-history and detection-history use `ACCEPT_ISSUES` media type (application/vnd.polaris.findings.issues-1+json)
  - Triage history is cursor-paginated (getAllCursor), detection history returns a single object (client.get)
  - The TriageHistoryTransaction type reuses existing TriageProperty and TriageAuthor types
  - New tool files follow exact same pattern as get-issue.ts: schema object + ToolDefinition export
  - npm package downloads may stall indefinitely in this sandbox (network restriction); deno lint/fmt work fine
---

## 2026-02-19 - PRD-TL2

- Implemented tool listing, detail, download descriptor, and license MCP tools
- Files changed:
  - `src/mcp/tools/get-tools.ts`: New tool get_tools (list tools with optional RSQL filter)
  - `src/mcp/tools/get-tool.ts`: New tool get_tool (single tool by name:version ID)
  - `src/mcp/tools/get-download-descriptor.ts`: New tool get_download_descriptor (signed download URL)
  - `src/mcp/tools/get-tool-license.ts`: New tool get_tool_license (license file download)
  - `src/mcp/tools/index.ts`: Registered all 4 new tools (with conflict resolution for agent-4's version mapping tools)
  - `prd.json`: Set PRD-TL2 passes: true
- `deno lint` passes, `deno fmt --check` passes
- **Learnings for future iterations:**
  - Agent-1 implemented the full PRD-TL1 foundation (types, API layer, service layer) before I started — check origin branch first
  - Parallel agents often conflict on src/mcp/tools/index.ts — always merge both sides when resolving import/array conflicts
  - The license endpoint uses `application/octet-stream` as Accept header (not a vendor media type)
  - Service functions in agent-1's style use inline anonymous types `{ id: string }` rather than named exports for simple cases
  - `src/services/index.ts` DOES need to be updated for new service modules (it was updated by agent-1 for tools.ts)
---
