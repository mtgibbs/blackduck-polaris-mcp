## Codebase Patterns

- IssueQueryParams and GetIssueParams in src/api/findings.ts already had includeIssueExclusion, includeExtensionProperties, includeComponentLocations — these were not being exposed at service/tool layer
- AssistResponse: spec shows fields as required, but PRD requires making them optional for defensive typing
- TriageAuthor.id: spec shows it as required but PRD requires making it optional
- IssueContext.tenantId and _links ARE in the spec — keep them, don't remove
- deno lint and deno fmt --check both work fine without network access

---

## 2026-02-19 - PRD-F1
- Implemented all acceptance criteria for PRD-F1 (Fix shared types and existing issue endpoint gaps)
- Files changed:
  - `src/types/polaris.ts`: TriageAuthor.id changed to optional (id?: string); AssistResponse fields summary, codeAnalysis, analysis, suggestedFix changed to optional
  - `src/services/findings.ts`: GetIssuesOptions gained includeIssueExclusion, includeExtensionProperties, includeComponentLocations; getIssues() passes them to API; GetIssueOptions gained includeIssueExclusion, includeExtensionProperties; getIssue() passes them to API
  - `src/mcp/tools/get-issues.ts`: Added optional schema fields include_issue_exclusion, include_extension_properties, include_component_locations wired to service
  - `src/mcp/tools/get-issue.ts`: Added optional schema fields include_issue_exclusion, include_extension_properties wired to service
  - `prd.json`: Set PRD-F1 passes: true
- `deno lint` passes, `deno fmt --check` passes
- **Learnings for future iterations:**
  - The API layer (src/api/findings.ts) already had all three include* params in IssueQueryParams and GetIssueParams — only service and tool layers needed updating
  - IssueContext spec includes tenantId and _links, so no cleanup was needed there
  - Both lint and fmt checks pass without network access
---

## 2026-02-19 - PRD-P3
- Implemented full Project CRUD (get, create, update, delete) across all layers
- Files changed:
  - `src/api/portfolio.ts`: Refactored getProject to options-object pattern; added createProject (POST), updateProject (PATCH), deleteProject (DELETE)
  - `src/services/portfolio.ts`: Added GetProjectOptions, CreateProjectOptions, UpdateProjectOptions, DeleteProjectOptions interfaces; refactored getProject and added createProject, updateProject, deleteProject service wrappers
  - `src/mcp/tools/get-project.ts`: New tool get_project (readOnlyHint: true)
  - `src/mcp/tools/create-project.ts`: New tool create_project (readOnlyHint: false)
  - `src/mcp/tools/update-project.ts`: New tool update_project (readOnlyHint: false)
  - `src/mcp/tools/delete-project.ts`: New tool delete_project (readOnlyHint: false, destructiveHint: true)
  - `src/mcp/tools/index.ts`: Registered all 4 new tools
  - `prd.json`: Set PRD-P3 passes: true
- `deno lint` passes, `deno fmt --check` passes
- **Learnings for future iterations:**
  - When refactoring positional-arg functions to options objects, check all callers (grep for `functionName(`) to avoid breaking existing usages
  - The service layer imports specific types (CreateProjectRequest, UpdateProjectRequest) to construct the body object — avoids spreading unknown fields
  - All 4 project CRUD tools use the standard pattern: plain Zod schema object, ToolDefinition<typeof schema>, handler calls service then returns jsonResponse
---

## 2026-02-19 - PRD-P1
- Added all 24 TypeScript interfaces to src/types/polaris.ts in the '// --- Portfolio ---' section, between the Branch interface and '// --- Findings ---'
- Interfaces added: CreateApplicationRequest, UpdateApplicationRequest, CreateProjectRequest, UpdateProjectRequest, CreateBranchRequest, UpdateBranchRequest, ProjectSubResource, ProjectSubResourceCountItem, Profile, ProfileArtifact, CreateProfileArtifactRequest, Label, CreateLabelRequest, MergeLabelRequest, ApplicationEntitlementItem, ApplicationEntitlementsResponse, EntitlementQuantityUpdateRequest, EntitlementQuantityUpdateResponse, PortfolioEntitlement, OrganizationSettings, RiskCategory, RiskFactor, RiskScoringSettings, DashboardItem
- Files changed: src/types/polaris.ts, prd.json
- Dependency order respected: RiskCategory before RiskFactor before RiskScoringSettings; ApplicationEntitlementItem before ApplicationEntitlementsResponse
- `deno lint` passes, `deno fmt --check` passes
- **Learnings for future iterations:**
  - Profile uses `LinkEntry[]` for _links — the LinkEntry type is defined later in the file (// --- Common --- section) but TypeScript handles forward references in interfaces fine
  - ProjectSubResource.additionalProperties field name is the same as TypeScript's `additionalProperties` but that's fine since it's an explicit typed field, not an index signature
  - All portfolio types live in src/types/polaris.ts (not separate files); add them after the Branch interface in the Portfolio section
  - MergeLabelRequest.targetLabel uses inline object type `{ name: string; description?: string }` per spec
---

## 2026-02-19 - PRD-P4
- Implemented Branch CRUD + portfolio-wide project and branch queries
- Files changed:
  - `src/api/portfolio.ts`: Added imports for CreateBranchRequest, UpdateBranchRequest; added getBranch, createBranch, updateBranch, deleteBranch, getPortfolioBranches functions
  - `src/services/portfolio.ts`: Added imports for CreateBranchRequest, UpdateBranchRequest; added GetBranchOptions, CreateBranchOptions, UpdateBranchOptions, DeleteBranchOptions, GetPortfolioBranchesOptions interfaces and corresponding service functions
  - `src/mcp/tools/get-branch.ts`: New tool get_branch (readOnlyHint: true)
  - `src/mcp/tools/create-branch.ts`: New tool create_branch (readOnlyHint: false)
  - `src/mcp/tools/update-branch.ts`: New tool update_branch (readOnlyHint: false)
  - `src/mcp/tools/delete-branch.ts`: New tool delete_branch (readOnlyHint: false, destructiveHint: true)
  - `src/mcp/tools/get-portfolio-projects.ts`: New tool get_portfolio_projects wrapping existing getProjects({portfolioId}) without applicationId
  - `src/mcp/tools/get-portfolio-branches.ts`: New tool get_portfolio_branches (readOnlyHint: true)
  - `src/mcp/tools/index.ts`: Registered all 6 new tools
  - `prd.json`: Set PRD-P4 passes: true
- `deno lint` passes, `deno fmt --check` passes
- **Learnings for future iterations:**
  - Parallel agents may modify the same files; rebase conflicts in portfolio.ts and services/portfolio.ts were resolved by merging both sets of imports (PRD-P2 added Application types, PRD-P4 added Branch types)
  - The portfolio-wide project listing reuses existing getProjects() with no applicationId — just a new tool wrapper, no new API/service function needed
  - deno fmt collapses multi-line description strings to single line when they fit within 100 chars — run `deno fmt` then re-check if fmt fails
  - getPortfolioBranches uses a separate API path /api/portfolios/{portfolioId}/branches (not the project-scoped path)
---

## 2026-02-19 - PRD-P6
- Implemented Artifacts + Entitlements across all layers
- Files changed:
  - `src/api/portfolio.ts`: Added imports for new types; added ACCEPT_ARTIFACTS, ACCEPT_APP_ENTITLEMENTS, ACCEPT_ENTITLEMENT_QTY, ACCEPT_PORTFOLIO_ENTITLEMENTS constants; added createArtifact (POST), getArtifact (GET), getApplicationEntitlements (GET), updateEntitlementQuantity (PATCH), getPortfolioEntitlements (GET) functions
  - `src/services/portfolio.ts`: Added imports for new types; added CreateArtifactOptions, GetArtifactOptions, GetApplicationEntitlementsOptions, UpdateEntitlementQuantityOptions, GetPortfolioEntitlementsOptions interfaces and corresponding service functions
  - `src/mcp/tools/create-artifact.ts`: New tool create_artifact (readOnlyHint: false)
  - `src/mcp/tools/get-artifact.ts`: New tool get_artifact (readOnlyHint: true)
  - `src/mcp/tools/get-application-entitlements.ts`: New tool get_application_entitlements (readOnlyHint: true)
  - `src/mcp/tools/update-entitlement-quantity.ts`: New tool update_entitlement_quantity (readOnlyHint: false)
  - `src/mcp/tools/get-portfolio-entitlements.ts`: New tool get_portfolio_entitlements (readOnlyHint: true)
  - `src/mcp/tools/index.ts`: Registered all 5 new tools
  - `prd.json`: Set PRD-P6 passes: true
- `deno task check` passes, `deno task lint` passes, `deno fmt --check` passes
- **Learnings for future iterations:**
  - getArtifact uses client.get<T>(path) with no accept header (spec returns application/octet-stream for the binary, but we model the JSON metadata response)
  - Long string constants > 100 chars need wrapping: `const ACCEPT_APP_ENTITLEMENTS =\n  "...";` pattern
  - handler function arg destructuring > 100 chars needs multi-line format: `handler: async (\n  { ... },\n) => {`
  - Run `deno fmt` then re-check when fmt fails — it auto-fixes both constant and handler formatting
---
